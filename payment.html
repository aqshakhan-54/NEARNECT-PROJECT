<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment & Booking - NearNect</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    :root {
      --primary: #6c5ce7;
      --secondary: #E91E63;
      --success: #00b894;
      --warning: #fdcb6e;
      --danger: #e17055;
      --info: #74b9ff;
      --dark: #2d3436;
      --light: #ddd6fe;
      --bg: #f8f9fa;
      --text: #2d3436;
      --border: #e9ecef;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(233,30,99,0.1));
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .header p {
      color: #6c757d;
      font-size: 1.1rem;
    }

    .booking-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      margin-bottom: 30px;
    }

    .booking-form {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section h3 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-section h3 i {
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(108,92,231,0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .checkbox-group label {
      margin: 0;
      font-weight: 500;
    }

    .booking-summary {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .provider-card {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 1px solid var(--border);
    }

    .provider-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
    }

    .provider-info h4 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .provider-info p {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .provider-rating {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }

    .provider-rating .stars {
      color: #ffc107;
    }

    .service-details {
      margin-bottom: 25px;
    }

    .service-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f8f9fa;
    }

    .service-item:last-child {
      border-bottom: none;
    }

    .service-name {
      font-weight: 600;
    }

    .service-price {
      font-weight: 700;
      color: var(--primary);
    }

    .price-breakdown {
      margin-bottom: 25px;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .price-row.total {
      font-weight: 700;
      font-size: 1.1rem;
      padding-top: 15px;
      border-top: 2px solid var(--border);
      color: var(--primary);
    }

    .payment-methods {
      margin-bottom: 25px;
    }

    .payment-method {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .payment-method:hover {
      border-color: var(--primary);
    }

    .payment-method.selected {
      border-color: var(--primary);
      background: rgba(108,92,231,0.05);
    }

    .payment-method input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .payment-method i {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .payment-method .method-info {
      flex: 1;
    }

    .payment-method .method-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .payment-method .method-desc {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(108,92,231,0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn.loading {
      pointer-events: none;
    }

    .btn.loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .security-badges {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .security-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #6c757d;
      font-size: 0.8rem;
    }

    .security-badge i {
      color: var(--success);
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 25px;
      background: white;
      box-shadow: var(--shadow);
      margin: 0 10px;
      transition: all 0.3s ease;
    }

    .step.active {
      background: var(--primary);
      color: white;
    }

    .step.completed {
      background: var(--success);
      color: white;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .step.active .step-number {
      background: rgba(255,255,255,0.3);
    }

    .step.completed .step-number {
      background: rgba(255,255,255,0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .booking-container {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .progress-steps {
        flex-direction: column;
        gap: 10px;
      }

      .step {
        margin: 0;
      }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    /* Success Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow);
    }

    .modal-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--success);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin: 0 auto 20px;
    }

    .modal h2 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text);
    }

    .modal p {
      color: #6c757d;
      margin-bottom: 30px;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn.primary {
      background: var(--primary);
      color: white;
    }

    .modal-btn.secondary {
      background: #f8f9fa;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Complete Your Booking</h1>
      <p>Review your service details and make payment</p>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step completed">
        <div class="step-number">1</div>
        <span>Service Details</span>
      </div>
      <div class="step active">
        <div class="step-number">2</div>
        <span>Payment</span>
      </div>
      <div class="step">
        <div class="step-number">3</div>
        <span>Confirmation</span>
      </div>
    </div>

    <div class="booking-container">
      <!-- Booking Form -->
      <div class="booking-form">
        <div class="form-section">
          <h3><i class="fas fa-calendar-alt"></i> Booking Details</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="bookingDate">Preferred Date</label>
              <input type="date" id="bookingDate" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="bookingTime">Preferred Time</label>
              <select id="bookingTime" class="form-input" required>
                <option value="">Select Time</option>
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="serviceAddress">Service Address</label>
            <textarea id="serviceAddress" class="form-input form-textarea" placeholder="Enter your complete address where service is needed" required></textarea>
          </div>

          <div class="form-group">
            <label for="specialInstructions">Special Instructions</label>
            <textarea id="specialInstructions" class="form-input form-textarea" placeholder="Any specific requirements or instructions for the service provider"></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas fa-user"></i> Contact Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="contactName">Full Name</label>
              <input type="text" id="contactName" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="contactPhone">Phone Number</label>
              <input type="tel" id="contactPhone" class="form-input" required>
            </div>
          </div>

          <div class="form-group">
            <label for="contactEmail">Email Address</label>
            <input type="email" id="contactEmail" class="form-input" required>
          </div>
        </div>

        <div class="form-section">
          <h3><i class="fas fa-shield-alt"></i> Terms & Conditions</h3>
          
          <div class="checkbox-group">
            <input type="checkbox" id="agreeTerms" required>
            <label for="agreeTerms">I agree to the <a href="#" style="color: var(--primary);">Terms & Conditions</a> and <a href="#" style="color: var(--primary);">Privacy Policy</a></label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="agreeCancellation" required>
            <label for="agreeCancellation">I understand the <a href="#" style="color: var(--primary);">cancellation policy</a></label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="agreePricing" required>
            <label for="agreePricing">I agree to the pricing and any additional charges</label>
          </div>
        </div>
      </div>

      <!-- Booking Summary -->
      <div class="booking-summary">
        <div class="provider-card">
          <img src="https://images.unsplash.com/photo-1581091014534-3e89df7cf2a5?q=80&w=100&h=100&auto=format&fit=crop" alt="Provider" class="provider-avatar">
          <div class="provider-info">
            <h4>Ali Khan</h4>
            <p>Professional Plumber</p>
            <div class="provider-rating">
              <span class="stars">★★★★★</span>
              <span>4.8 (150 reviews)</span>
            </div>
          </div>
        </div>

        <div class="service-details">
          <h4 style="margin-bottom: 15px; font-weight: 700;">Service Details</h4>
          <div class="service-item">
            <span class="service-name">Plumbing Repair</span>
            <span class="service-price">₹500</span>
          </div>
          <div class="service-item">
            <span class="service-name">Service Fee</span>
            <span class="service-price">₹50</span>
          </div>
          <div class="service-item">
            <span class="service-name">Materials (if needed)</span>
            <span class="service-price">₹100</span>
          </div>
        </div>

        <div class="price-breakdown">
          <div class="price-row">
            <span>Subtotal</span>
            <span>₹650</span>
          </div>
          <div class="price-row">
            <span>GST (18%)</span>
            <span>₹117</span>
          </div>
          <div class="price-row total">
            <span>Total Amount</span>
            <span>₹767</span>
          </div>
        </div>

        <div class="payment-methods">
          <h4 style="margin-bottom: 15px; font-weight: 700;">Payment Method</h4>
          
          <div class="payment-method selected" onclick="selectPaymentMethod('upi')">
            <input type="radio" name="paymentMethod" value="upi" checked>
            <i class="fas fa-mobile-alt"></i>
            <div class="method-info">
              <div class="method-name">UPI Payment</div>
              <div class="method-desc">Pay using UPI apps like PhonePe, Google Pay</div>
            </div>
          </div>

          <div class="payment-method" onclick="selectPaymentMethod('card')">
            <input type="radio" name="paymentMethod" value="card">
            <i class="fas fa-credit-card"></i>
            <div class="method-info">
              <div class="method-name">Credit/Debit Card</div>
              <div class="method-desc">Visa, Mastercard, RuPay</div>
            </div>
          </div>

          <div class="payment-method" onclick="selectPaymentMethod('netbanking')">
            <input type="radio" name="paymentMethod" value="netbanking">
            <i class="fas fa-university"></i>
            <div class="method-info">
              <div class="method-name">Net Banking</div>
              <div class="method-desc">All major banks supported</div>
            </div>
          </div>

          <div class="payment-method" onclick="selectPaymentMethod('cod')">
            <input type="radio" name="paymentMethod" value="cod">
            <i class="fas fa-money-bill-wave"></i>
            <div class="method-info">
              <div class="method-name">Cash on Service</div>
              <div class="method-desc">Pay after service completion</div>
            </div>
          </div>
        </div>

        <button class="btn" id="payButton" onclick="processPayment()">
          <i class="fas fa-lock"></i>
          Pay ₹767 & Book Service
        </button>

        <div class="security-badges">
          <div class="security-badge">
            <i class="fas fa-shield-alt"></i>
            <span>SSL Secured</span>
          </div>
          <div class="security-badge">
            <i class="fas fa-lock"></i>
            <span>256-bit Encryption</span>
          </div>
          <div class="security-badge">
            <i class="fas fa-check-circle"></i>
            <span>PCI Compliant</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal" id="successModal">
    <div class="modal-content">
      <div class="modal-icon">
        <i class="fas fa-check"></i>
      </div>
      <h2>Booking Confirmed!</h2>
      <p>Your service has been successfully booked. You will receive a confirmation email shortly.</p>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closeModal()">Close</button>
        <button class="modal-btn primary" onclick="goToDashboard()">View Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // API Base URL
    function getApiBase(){
      if(typeof window === 'undefined') return '';
      if(window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:' || !window.location.hostname) 
        return (window.NEARNect_API_BASE || 'http://localhost:5000');
      return (window.NEARNect_API_BASE || 'https://your-render-app.onrender.com');
    }

    function getToken(){ try { return localStorage.getItem('nearnect_token'); } catch(e){ return null; } }
    function authHeaders(){ const t = getToken(); return t ? { Authorization: `Bearer ${t}` } : {}; }

    class BookingPayment {
      constructor() {
        this.bookingData = this.loadBookingData();
        this.bookingId = null;
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.populateForm();
        this.setMinDate();
      }

      loadBookingData() {
        // Load booking data from localStorage or URL parameters
        const params = new URLSearchParams(window.location.search);
        const workerId = params.get('workerId') || 'w1';
        
        // Get worker data from script.js
        const workers = JSON.parse(localStorage.getItem('nearnect_workers') || '[]');
        const defaultWorkers = [
          { id: "w1", name: "Ali Khan", skill: "Plumber", price: 500, img: "https://images.unsplash.com/photo-1581091014534-3e89df7cf2a5?q=80&w=400&auto=format&fit=crop", distanceKm: 2.5, rating: 4.6, description: "Expert in leak fixes, fitting, and bathroom installations.", experience: "8+ years", completedJobs: 150 }
        ];
        
        const allWorkers = [...defaultWorkers, ...workers];
        return allWorkers.find(w => w.id === workerId) || allWorkers[0];
      }

      setupEventListeners() {
        // Form validation
        document.getElementById('bookingDate').addEventListener('change', this.validateForm.bind(this));
        document.getElementById('bookingTime').addEventListener('change', this.validateForm.bind(this));
        document.getElementById('serviceAddress').addEventListener('input', this.validateForm.bind(this));
        document.getElementById('contactName').addEventListener('input', this.validateForm.bind(this));
        document.getElementById('contactPhone').addEventListener('input', this.validateForm.bind(this));
        document.getElementById('contactEmail').addEventListener('input', this.validateForm.bind(this));
        
        // Terms checkboxes
        document.getElementById('agreeTerms').addEventListener('change', this.validateForm.bind(this));
        document.getElementById('agreeCancellation').addEventListener('change', this.validateForm.bind(this));
        document.getElementById('agreePricing').addEventListener('change', this.validateForm.bind(this));
      }

      populateForm() {
        // Pre-fill form with user data if available
        const currentUser = JSON.parse(localStorage.getItem('nearnect_current_user') || '{}');
        
        if (currentUser.name) {
          document.getElementById('contactName').value = currentUser.name;
        }
        if (currentUser.email) {
          document.getElementById('contactEmail').value = currentUser.email;
        }
        if (currentUser.phone) {
          document.getElementById('contactPhone').value = currentUser.phone;
        }
      }

      setMinDate() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const dateInput = document.getElementById('bookingDate');
        dateInput.min = tomorrow.toISOString().split('T')[0];
        dateInput.value = tomorrow.toISOString().split('T')[0];
      }

      validateForm() {
        const requiredFields = [
          'bookingDate', 'bookingTime', 'serviceAddress', 
          'contactName', 'contactPhone', 'contactEmail'
        ];
        
        const requiredCheckboxes = [
          'agreeTerms', 'agreeCancellation', 'agreePricing'
        ];

        let isValid = true;

        // Check required fields
        requiredFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (!field.value.trim()) {
            isValid = false;
          }
        });

        // Check required checkboxes
        requiredCheckboxes.forEach(checkboxId => {
          const checkbox = document.getElementById(checkboxId);
          if (!checkbox.checked) {
            isValid = false;
          }
        });

        // Update pay button state
        const payButton = document.getElementById('payButton');
        payButton.disabled = !isValid;
        
        return isValid;
      }

      async processPayment() {
        if (!this.validateForm()) {
          this.showToast('Please fill in all required fields', 'error');
          return;
        }

        const payButton = document.getElementById('payButton');
        payButton.classList.add('loading');
        payButton.disabled = true;

        try {
          // First create booking
          const booking = await this.createBooking();
          if (!booking) {
            throw new Error('Failed to create booking');
          }

          this.bookingId = booking._id || booking.id;
          const amount = this.bookingData.price || 767;
          const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

          // Handle Cash on Service (COD)
          if (paymentMethod === 'cod' || paymentMethod === 'cash') {
            await this.handleCashPayment(booking);
            return;
          }

          // Create Razorpay order for online payment
          await this.initiateRazorpayPayment(amount, paymentMethod);
        } catch (err) {
          console.error('Payment error:', err);
          this.showToast(err.message || 'Payment failed. Please try again.', 'error');
          payButton.classList.remove('loading');
          payButton.disabled = false;
        }
      }

      async createBooking() {
        const scheduledFor = new Date(`${document.getElementById('bookingDate').value}T${document.getElementById('bookingTime').value}:00`);
        const bookingData = {
          workerId: this.bookingData.id,
          service: this.bookingData.skill || 'Service',
          scheduledFor: scheduledFor.toISOString(),
          address: document.getElementById('serviceAddress').value,
          instructions: document.getElementById('specialInstructions').value || '',
          customerName: document.getElementById('contactName').value,
          customerPhone: document.getElementById('contactPhone').value,
          customerEmail: document.getElementById('contactEmail').value,
          amount: this.bookingData.price || 767
        };

        const res = await fetch(`${getApiBase()}/bookings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(bookingData)
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({ error: 'Failed to create booking' }));
          throw new Error(error.error || 'Failed to create booking');
        }

        return await res.json();
      }

      async handleCashPayment(booking) {
        // For cash payment, mark booking as confirmed without payment
        const res = await fetch(`${getApiBase()}/bookings/${this.bookingId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ status: 'confirmed' })
        });

        if (res.ok) {
          this.showSuccess();
        } else {
          throw new Error('Failed to confirm booking');
        }
      }

      async initiateRazorpayPayment(amount, paymentMethod) {
        // Create payment order
        const res = await fetch(`${getApiBase()}/payments/create-order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({
            bookingId: this.bookingId,
            amount: amount,
            paymentMethod: paymentMethod
          })
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({ error: 'Failed to create payment order' }));
          throw new Error(error.error || 'Failed to create payment order');
        }

        const orderData = await res.json();

        // Open Razorpay checkout
        const options = {
          key: orderData.key,
          amount: orderData.amount,
          currency: orderData.currency,
          order_id: orderData.orderId,
          name: 'NearNect',
          description: `Payment for ${this.bookingData.skill || 'Service'}`,
          prefill: {
            name: document.getElementById('contactName').value,
            email: document.getElementById('contactEmail').value,
            contact: document.getElementById('contactPhone').value
          },
          handler: (response) => {
            this.handlePaymentSuccess(response);
          },
          modal: {
            ondismiss: () => {
              const payButton = document.getElementById('payButton');
              payButton.classList.remove('loading');
              payButton.disabled = false;
            }
          }
        };

        const razorpay = new Razorpay(options);
        razorpay.open();
      }

      async handlePaymentSuccess(response) {
        try {
          // Verify payment
          const res = await fetch(`${getApiBase()}/payments/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify({
              orderId: response.razorpay_order_id,
              paymentId: response.razorpay_payment_id,
              signature: response.razorpay_signature,
              bookingId: this.bookingId
            })
          });

          if (res.ok) {
            this.showSuccess();
          } else {
            const error = await res.json().catch(() => ({ error: 'Payment verification failed' }));
            throw new Error(error.error || 'Payment verification failed');
          }
        } catch (err) {
          console.error('Payment verification error:', err);
          this.showToast('Payment verification failed. Please contact support.', 'error');
          
          // Record failed payment
          await fetch(`${getApiBase()}/payments/failed`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify({
              orderId: response.razorpay_order_id,
              paymentId: response.razorpay_payment_id,
              bookingId: this.bookingId,
              error: { description: err.message }
            })
          });

          const payButton = document.getElementById('payButton');
          payButton.classList.remove('loading');
          payButton.disabled = false;
        }
      }

      showSuccess() {
        // Show success modal
        document.getElementById('successModal').classList.add('show');
        
        // Reset button
        const payButton = document.getElementById('payButton');
        payButton.classList.remove('loading');
        payButton.disabled = false;
      }

      showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            toast.textContent = '';
          }, 300);
        }, 3000);
      }
    }

    // Global functions
    function selectPaymentMethod(method) {
      // Remove selected class from all methods
      document.querySelectorAll('.payment-method').forEach(method => {
        method.classList.remove('selected');
      });
      
      // Add selected class to clicked method
      event.currentTarget.classList.add('selected');
      
      // Update radio button
      document.querySelector(`input[value="${method}"]`).checked = true;
    }

    function processPayment() {
      if (window.bookingPayment) {
        window.bookingPayment.processPayment();
      }
    }

    function closeModal() {
      document.getElementById('successModal').classList.remove('show');
    }

    function goToDashboard() {
      window.location.href = 'user-dashboard.html';
    }

    // Initialize booking payment system
    document.addEventListener('DOMContentLoaded', () => {
      window.bookingPayment = new BookingPayment();
    });
  </script>
</body>
</html>
